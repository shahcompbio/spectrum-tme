---
title: "MSK SPECTRUM data freeze: inferCNV"
author: "Florian Uhlitz"
date: "`r Sys.Date()`"
output: 
  html_document: 
    df_print: kable
    number_sections: yes
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = F)

```

# InferCNV 

```{r chunk_360_010}

library(magrittr)
library(tidyverse)
library(Seurat)
library(readxl)
library(cowplot)
library(viridis)
library(ggpubr)
library(ggdendro)
library(dendextend)
library(infercnv)

```

```{r chunk_360_020}

## load global vars: 
source("src/global_vars.R")

# scrna_meta_tbl
# clrs
# markers_v7
# markers_v7_super
# cell_type_super_lookup

```

```{r chunk_360_040}

## load full seurat objects with expression data
seu_obj_cc <- read_rds("/work/shah/users/uhlitzf/data/SPECTRUM/freeze/v7/Ovarian.cancer.super_processed_filtered_annotated.rds")
marker_tbl <- read_tsv("/work/shah/users/uhlitzf/data/SPECTRUM/freeze/v7/supplementary_tables/Ovarian.cancer.super_marker_table_annotated.tsv")

marker_tbl_top <- marker_tbl %>% 
  filter(avg_logFC > 0.5, 
         p_val_adj < 0.01,
         pct.1 > 0.2,
         pct.2 < 0.8,
         !is.na(cluster_label)) %>% 
  group_by(cluster_label) %>% 
  slice(1:50)

myfeatures <- c("UMAP_1", "UMAP_2", "umapharmony_1", "umapharmony_2", "sample", "doublet", "nCount_RNA", "nFeature_RNA", "percent.mt", "doublet_score", "cell_type", "cell_id")

my_subtypes <- names(clrs$cluster_label$Ovarian.cancer.super)
coi <- "Ovarian.cancer.super"

mois <- c("HRD-Dup", "HRD-Del", "FBI")
gois <- c("HLA-A", "HLA-B", "HLA-C", "B2M", "HLA-DRA", "HLA-DRB1", "CD274")
sois <- c("Adnexa", "Omentum", "Ascites")
pois_short <- c("JAK.STAT", "NFkB", "TNFa", "TGFb", "Hypoxia")
pois <- paste0(pois_short, ".pathway")
all_pws <- grep("pathway", colnames(seu_obj_cc@meta.data), value = T)
all_pws_short <- str_remove_all(all_pws, "\\.pathway")


## load inferCNV outputs -------------------------------

inferCNV_dirs <- list.files("/work/shah/users/shih/infercnv_pipeline/data/infercnv", pattern = "20210709", full.names = T) %>% grep("SPECTRUM", ., value = T)

inferCNV_clone_files <- paste0(inferCNV_dirs, "/rand_tree_tumor_subcluters.csv")

inferCNV_clone_tbl <- lapply(inferCNV_clone_files, read_csv) %>% 
  bind_rows %>% 
  rename(clone_label = cluster_name)

clrs$clone_label <- magma(length(unique(inferCNV_clone_tbl$clone_label)))
names(clrs$clone_label) <- sort(unique(inferCNV_clone_tbl$clone_label))


## load BAF annotation -------------------------------

baf_tbl_full <- read_tsv("/work/shah/vazquezi/data/transfers/spectrum/results/scrna/v27/ascn/outputs/ascn/cell-type/Ovarian.cancer.cell.tsv")
baf_tbl <- baf_tbl_full %>% 
  filter(chrarm == "6p") %>% 
  group_by(patient) %>%
  mutate(UMAP_1_z = (UMAP_1 - mean(UMAP_1)) / sd(UMAP_2),
         UMAP_2_z = (UMAP_2 - mean(UMAP_2)) / sd(UMAP_2)) %>% 
  filter(UMAP_1_z < 3, UMAP_1_z > -3,
         UMAP_2_z < 3, UMAP_2_z > -3) %>% 
  ungroup() %>% 
  select(cell_id, UMAP_1, UMAP_2, BAF6p = BAF)


## single cell annotation ---------------------------

anno_data <- seu_obj_cc %>% 
  FetchData(c("sample", "cell_id", "cluster_label", "JAK.STAT.pathway", "NFkB.pathway", "TNFa.pathway", "TGFb.pathway", "Hypoxia.pathway")) %>%
  as_tibble() %>% 
  left_join(scrna_meta_tbl, by = "sample") %>% 
  left_join(inferCNV_clone_tbl, by = "cell_id") %>% 
  # filter(!is.na(clone_label)) %>%
  left_join(baf_tbl, by = "cell_id")

```

# UMAPs

## patients

```{r chunk_360_050}

anno_data_sub <- anno_data %>% 
  filter(patient_id %in% c("SPECTRUM-OV-036", "SPECTRUM-OV-007", "SPECTRUM-OV-107"))

p1 <- ggplot(anno_data_sub, aes(UMAP_1, UMAP_2, color = tumor_supersite)) + 
  ggrastr::geom_point_rast(size = 0.01, scale = 0.2, raster.dpi = 60) +
  facet_wrap(~patient_id_short, scales = "free") +
  scale_color_manual(values = clrs$tumor_supersite) +
  remove_xaxis +
  remove_yaxis

p2 <- ggplot(anno_data_sub, aes(UMAP_1, UMAP_2, color = cluster_label)) + 
  ggrastr::geom_point_rast(size = 0.01, scale = 0.2, raster.dpi = 60) +
  facet_wrap(~patient_id_short, scales = "free") +
  scale_color_manual(values = clrs$cluster_label$Ovarian.cancer.super) +
  remove_xaxis +
  remove_yaxis

p3 <- ggplot(anno_data_sub, aes(UMAP_1, UMAP_2, color = JAK.STAT.pathway)) + 
  ggrastr::geom_point_rast(size = 0.01, scale = 0.2, raster.dpi = 60) +
  facet_wrap(~patient_id_short, scales = "free") +
  scale_color_viridis() +
  remove_xaxis +
  remove_yaxis

p4 <- ggplot(anno_data_sub) + 
  ggrastr::geom_point_rast(aes(UMAP_1, UMAP_2), color = "grey80", size = 0.01, 
                           scale = 0.2, raster.dpi = 60) +
  ggrastr::geom_point_rast(aes(UMAP_1, UMAP_2, color = clone_label), size = 0.5,
                           scale = 0.2, raster.dpi = 60,
                           data = filter(anno_data_sub, !is.na(clone_label))) +
  facet_wrap(~patient_id_short, scales = "free") +
  scale_color_manual(values = clrs$clone_label) +
  remove_xaxis +
  remove_yaxis

p5 <- ggplot(anno_data_sub, aes(UMAP_1, UMAP_2, color = BAF6p)) + 
  ggrastr::geom_point_rast(size = 0.01, scale = 0.2, raster.dpi = 60) +
  facet_wrap(~patient_id_short, scales = "free") +
  scale_color_viridis() +
  remove_xaxis +
  remove_yaxis

plot_grid(p1, p2, p3, p4, p5, ncol = 1, align = "hv")


```

## cohort

```{r chunk_360_080}

plot_data <- cbind(cell_id = colnames(seu_obj_cc), FetchData(seu_obj_cc, c("umapharmony_1", "umapharmony_2", "umappca_1", "umappca_2", "RNA_snn_res.0.2", "sample", "cluster_label", gois, all_pws))) %>% 
  as_tibble() %>% 
  left_join(scrna_meta_tbl, by = "sample") %>% 
  filter(!is.na(consensus_signature)) %>% 
  mutate(tumor_megasite = str_replace_all(tumor_megasite, "Other", "Non-adnexa")) %>% 
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Ovarian.cancer.super)),
         cluster_number = as.numeric(cluster_label)) %>% 
  mutate(umapscaled_1 = scales::rescale(umapharmony_1),
         umapscaled_2 = scales::rescale(umapharmony_2)) %>% 
  left_join(inferCNV_clone_tbl, by = "cell_id")

base_umap <- ggplot(plot_data) +
  coord_fixed() +
  NoAxes() +
  theme(legend.position = c(0, 1),
        legend.justification = c("left", "top"),
        legend.box.just = "left",
        legend.margin = margin(1, 1, 1, 1),
        legend.text = element_text(size = 14, margin = margin(0, 10, 0, 0)),
        legend.spacing.x = unit(0, "npc"), 
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = 0.5, face = "plain", size = 22))

```

```{r chunk_360_090}

pt.size <- 0.1
pt.size2 <- 0.2
pt.size.mini <- 0.01
pt.alpha <- 0.05
pt.alpha.mini <- 0.02
dpi <- 150

median_tbl <- plot_data %>%
  group_by(patient_id_short) %>% 
  summarise(umappca_1 = median(umappca_1), 
            umappca_2 = median(umappca_2),
            umapscaled_1 = median(umapscaled_1),
            umapscaled_2 = median(umapscaled_2))

median_tbl_cluster <- plot_data %>%
  group_by(cluster_label, cluster_number) %>% 
  summarise(umapharmony_1 = median(umapharmony_1), 
            umapharmony_2 = median(umapharmony_2),
            umapscaled_1 = median(umapscaled_1),
            umapscaled_2 = median(umapscaled_2))

umap_pca_mutsig <- base_umap + 
  ggrastr::geom_point_rast(aes(umappca_1, umappca_2, color = consensus_signature), 
                           size = pt.size, alpha = pt.alpha, raster.dpi = dpi) +
  # geom_text(aes(umappca_1, umappca_2, label = patient_id_short), data = median_tbl) + 
  geom_label(aes(umappca_1, umappca_2, label = patient_id_short), color = "black",
             data = median_tbl, label.size = unit(0, "mm"), label.r = unit(0, "mm"),
             alpha = 0.5) +
  scale_color_manual(values = clrs$consensus_signature) +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 1),
                              ncol = 1, 
                              label.position = "right")) +
  labs(title = "Uncorrected")

umap_pca_cluster <- base_umap + 
  ggrastr::geom_point_rast(aes(umappca_1, umappca_2, color = cluster_label), 
                           size = pt.size, alpha = pt.alpha, raster.dpi = dpi) +
  geom_label(aes(umappca_1, umappca_2, label = patient_id_short), color = "black",
             data = median_tbl, label.size = unit(0, "mm"), label.r = unit(0, "mm"),
             alpha = 0.5) +
  scale_color_manual(values = clrs$cluster_label$Ovarian.cancer.super) +
  guides(color = guide_legend(override.aes = list(size = 4, alpha = 1),
                              ncol = 1, 
                              label.position = "right")) +
  labs(title = "Cluster")

cluster_legend <- cowplot::get_legend(umap_pca_cluster)

umap_pca_jak_stat <- base_umap + 
  # geom_point(aes(umappca_1, umappca_2), color = "grey80",
  #            size = pt.size, alpha = pt.alpha, 
  #            data = filter(plot_data, JAK.STAT.pathway <= 0)) +
  ggrastr::geom_point_rast(aes(umappca_1, umappca_2, color = JAK.STAT.pathway), 
                           size = pt.size, alpha = pt.alpha, raster.dpi = dpi, 
             data = mutate(plot_data, JAK.STAT.pathway = ifelse(JAK.STAT.pathway > 4, 4, JAK.STAT.pathway))) +
  geom_label(aes(umappca_1, umappca_2, label = patient_id_short), color = "black",
             data = median_tbl, label.size = unit(0, "mm"), label.r = unit(0, "mm"),
             alpha = 0.5) +
  scale_color_gradientn(colours = viridis(9), breaks = c(0, 2, 4), limits = c(min(plot_data$JAK.STAT.pathway), 4), labels = c(0, 2, "â‰¥4")) +
  labs(title = "JAK-STAT signaling")

umap_pca_clone <- base_umap + 
  ggrastr::geom_point_rast(aes(umappca_1, umappca_2, color = clone_label), 
                           size = pt.size, alpha = pt.alpha, raster.dpi = dpi, 
             data = filter(plot_data, !is.na(clone_label))) +
  geom_label(aes(umappca_1, umappca_2, label = patient_id_short), color = "black",
             data = median_tbl, label.size = unit(0, "mm"), label.r = unit(0, "mm"),
             alpha = 0.5) +
  scale_color_manual(values = clrs$clone_label) +
  labs(title = "inferCNV clone") +
  remove_guides

```

```{r chunk_360_100, fig.width=20, fig.height=5}

cancer_grid_pca <- ggdraw() +
  draw_plot(add_umap_coord(umap_pca_mutsig), 
            x = 0, y = 0, width = 0.25, height = 1) +
  draw_plot(add_umap_coord(umap_pca_cluster + guides(color = F)), 
            x = 0.24, y = 0, width = 0.25, height = 1) +
  draw_grob(cluster_legend, x = 0.5, y = -0.15, height = 1) +
  draw_plot(add_umap_coord(umap_pca_jak_stat), 
            x = 0.7, y = 0, width = 0.25, height = 1)

cancer_grid_pca

```

```{r chunk_360_110, fig.width=6, fig.height=5}

umap_pca_clone

```

## distributions per clone

```{r chunk_360_120, fig.width=6, fig.height=5}

## cell annotation
anno_data <- seu_obj_cc %>% 
  FetchData(c("sample", "cell_id", "cluster_label", "JAK.STAT.pathway", "NFkB.pathway", "TNFa.pathway", "TGFb.pathway", "Hypoxia.pathway")) %>%
  as_tibble() %>% 
  gather(key, value, -sample, -cell_id, -cluster_label) %>% 
  left_join(scrna_meta_tbl, by = "sample") %>% 
  left_join(inferCNV_clone_tbl, by = "cell_id")

```

```{r chunk_360_130, fig.width=6, fig.height=5}

anno_data %>% 
  filter(!is.na(clone_label)) %>% 
  group_by(patient_id_short, clone_label, tumor_supersite) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  # filter(patient_id_short %in% c("009", "026", "022")) %>% 
  filter(n > 100) %>% 
  filter(key == "JAK.STAT.pathway") %>% 
  ggplot() +
  geom_boxplot(aes(clone_label, value, fill = tumor_supersite)) +
  # facet_grid(patient_id_short~key) +
  facet_wrap(~patient_id_short) +
  scale_fill_manual(values = clrs$tumor_supersite) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0))

```


## session info 

```{r chunk_360_999}

devtools::session_info()

```

