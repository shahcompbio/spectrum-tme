---
title: "Generalized linear model of myeloid cell composition"
subtitle: "MSK SPECTRUM"
author:
  - "Ignacio Vazquez-Garcia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: tango
    df_print: paged
    code_folding: hide
    fig_align: center
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: yes
params:
   rmd: "630_Myeloid_cell_glm.Rmd"
---

# Generalized linear model of myeloid cell clusters

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(ggridges)
library(scales)
library(data.table)
library(tidytext)
library(cowplot)
library(ggthemes)
library(ggrepel)
library(corrplot)
library(viridisLite)
library(grid)
library(RColorBrewer)
library(lme4)
library(emmeans)
```

```{r}

## load global vars: 
source("src/global_vars.R")

names(clrs$patient_id) <- str_remove_all(names(clrs$patient_id), "SPECTRUM-OV-")
# names(clrs$cell_type) <- str_replace_all(names(clrs$cell_type), "\\.", " ")

```

```{r}

# scRNA

# Cell supertype Seurat
scrna_myeloid_cell_seu <- readr::read_rds("/work/shah/users/uhlitzf/data/SPECTRUM/freeze/v7/Myeloid.super_processed_filtered_annotated.rds")
scrna_myeloid_cell_tbl <- scrna_myeloid_cell_seu@meta.data %>%  
  dplyr::left_join(scrna_meta_tbl, by = c('sample', "patient_id"))

```

```{r}

scrna_cell_tbl <- scrna_myeloid_cell_tbl %>%
  # dplyr::left_join(scrna_myeloid_cell_tbl %>% dplyr::select(cell_id, cluster_label),
  #                  by = 'cell_id') %>%
  # dplyr::left_join(db$mutational_signatures, by = 'patient_id') %>%
  dplyr::filter(tumor_supersite != "Unknown") %>%
  dplyr::mutate(
    patient_id = str_remove(patient_id, "SPECTRUM-OV-"),
    sample_id = str_remove(sample_id, "OV-")
  )# %>%
  # mutate(tumor_megasite = ifelse(!tumor_supersite %in% c("Adnexa", "Ascites"),
  #                                "Non-Adnexa", tumor_supersite))

scrna_cell_tbl <- scrna_cell_tbl %>% mutate(
  consensus_signature = ordered(consensus_signature, levels = names(clrs$consensus_signature)),
  consensus_signature_short = ordered(
    consensus_signature_short,
    levels = names(clrs$consensus_signature_short)
  ),
  tumor_type = ordered(tumor_type, levels = names(clrs$tumor_type)),
  tumor_supersite = ordered(tumor_supersite, levels = names(clrs$tumor_supersite)),
  therapy = ordered(therapy, levels = names(clrs$therapy)),
  cell_type = ordered(cell_type, levels = names(clrs$cell_type))
)

```

```{r}

heatmap_layers <- list(
  scale_fill_gradient2(low = scales::muted("blue"), high = scales::muted("red"), 
                       na.value = "grey10"),
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.title = element_blank(),
        plot.margin = margin(0, 0, 0, 0),
        strip.text = element_blank())
)

```

```{r}

data <- list()
formulas <- list()
models <- list()
consensus_signature_emm <- list()
site_emm <- list()
consensus_signature_site_emm <- list()
BRCA_gene_mutation_status_emm <- list()

```

## Myeloid cell super clusters {.tabset}

```{r}

scrna_cluster_super_sample_tbl <- scrna_cell_tbl %>%
  mutate(cluster_label_super = case_when(
        str_detect(cluster_label, "M1") ~ "M1",
        str_detect(cluster_label, "M2") ~ "M2",
        str_detect(cluster_label, "DC") ~ "DC",
        TRUE ~ "Other"
        )) %>%
  mutate(cell_type = as.character(cell_type)) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  group_by(patient_id, consensus_signature, consensus_signature_short, tumor_type, tumor_megasite, tumor_supersite, tumor_subsite, therapy, sort_parameters, cell_type, cluster_label_super) %>%
  summarize(cell_state_count = n_distinct(cell_id)) %>% 
  mutate(
      other_cell_state_count = sum(cell_state_count) - cell_state_count,
      total_cell_state_count = sum(cell_state_count),
      cell_state_proportion = cell_state_count/total_cell_state_count*100
      ) %>%
  ungroup

```

#### GLM with fixed effects (signature + site) {.tabset}

```{r}

data[["Myeloid cell"]] <- scrna_cluster_super_sample_tbl
formulas[["Myeloid cell"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label_super * consensus_signature + cluster_label_super * tumor_supersite #+ cluster_label_super * sort_parameters
models[["Myeloid cell"]] <- glm(formula = formulas[["Myeloid cell"]], family = binomial(link = 'logit'), data = data[["Myeloid cell"]])

consensus_signature_emm[["Myeloid cell"]] <- emmeans(models[["Myeloid cell"]], specs = eff ~ consensus_signature | cluster_label_super, type = "response", tran = "logit", adjust = "bonferroni")
consensus_signature_odds <- consensus_signature_emm[["Myeloid cell"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

site_emm[["Myeloid cell"]] <- emmeans(models[["Myeloid cell"]], specs = eff ~ tumor_supersite | cluster_label_super, type = "response", tran = "logit", adjust = "bonferroni")
site_odds <- site_emm[["Myeloid cell"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

```

##### Signature + site contrasts

###### Portrait

```{r, fig.width = 3.6, fig.height = 4.5, results = "asis"}

plot_data <- bind_rows(consensus_signature_odds %>% add_column(contrast_variable = "Signature"),
                       site_odds %>% add_column(contrast_variable = "Site")) %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.05) %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  filter(!str_detect(contrast, "HRD effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = cluster_label_super, y = forcats::fct_rev(contrast), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥+0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_x_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(contrast_variable ~ ., scales = "free_y", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=0, y=forcats::fct_rev(contrast), fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(contrast_variable~., scales = "free", space = "free") +
  theme(# aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label_super, facet_helper, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(cluster_label_super, facet_helper, fill = cluster_label_super)) +
  geom_point(aes(cluster_label_super, facet_helper), color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(cluster_label_super, facet_helper, label = as.numeric(cluster_label_super))) +
  heatmap_layers +
  scale_fill_manual(values = clrs$cluster_label_super$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(~facet_helper, scales = "free", space = "free") +
  theme(# aspect.ratio = 1,
        axis.text.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_signature_site_anno + theme(plot.margin = margin(t = 6, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 0.35),
    rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_cluster_anno + theme(plot.margin = margin(t = 0, r = 6, b = 6, l = 6)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 0.35),
    rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(1, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_site_portrait.pdf", 
           p, width = 3.6, height = 4.5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_site_portrait.png", 
           p, width = 3.6, height = 4.5)

```

##### Signature contrasts

###### Portrait

```{r, fig.width = 3, fig.height = 3.5, results = "asis"}

plot_data <- consensus_signature_odds %>% add_column(contrast_variable = "Signature") %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.05) %>%
  mutate(p.value = ifelse(p.value < 1E-20, 1E-20, p.value)) %>%
  filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.3, 0.3, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.3, -0.3, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label_super), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.3, 0.3),
    labels = c("≤-0.3", 0, "≥0.3"),
    breaks = c(-0.3, 0, 0.3)
  ) +
  scale_size_continuous(
    limits = c(0, 20),
    breaks = c(0, 10, 20),
    labels = c(0, 10, 20)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_signature_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(# aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label_super, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label_super))) +
  geom_tile(aes(fill = cluster_label_super)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label_super))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label_super$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(# aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.9, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.9, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(1.35, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.25)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_portrait.pdf",
           p, width = 3, height = 3.5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_portrait.png",
           p, width = 3, height = 3.5)

```

###### Landscape

```{r, fig.width = 3.7, fig.height = 4, results = "asis"}

plot_data <- consensus_signature_odds %>% add_column(contrast_variable = "Signature") %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.05) %>%
  mutate(p.value = ifelse(p.value < 1E-20, 1E-20, p.value)) %>%
  filter(!str_detect(contrast, "HRD effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.3, 0.3, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.3, -0.3, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = cluster_label_super, y = forcats::fct_rev(contrast), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.3, 0.3),
    labels = c("≤-0.3", 0, "≥+0.3"),
    breaks = c(-0.3, 0, 0.3)
  ) +
  scale_size_continuous(
    limits = c(0, 20),
    breaks = c(0, 10, 20),
    labels = c(0, 10, 20)
  ) +
  scale_x_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(contrast_variable ~ ., scales = "free_y", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=0, y=forcats::fct_rev(contrast), fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(contrast_variable~., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label_super, facet_helper, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(cluster_label_super, facet_helper, fill = cluster_label_super)) +
  geom_point(aes(cluster_label_super, facet_helper), color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(cluster_label_super, facet_helper, label = as.numeric(cluster_label_super))) +
  heatmap_layers +
  scale_fill_manual(values = clrs$cluster_label_super$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(~facet_helper, scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_signature_site_anno + theme(plot.margin = margin(t = 5, r = 0, b = 25, l = 0)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 0.35),
    rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_cluster_anno + theme(plot.margin = margin(t = 0, r = 6, b = 6, l = 6)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 0.55),
    rel_widths = c(0.65, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.75, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_portrait.pdf", 
           p, width = 3.6, height = 4.5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_signature_portrait.png", 
           p, width = 3.6, height = 4.5)

```

##### Site contrasts

###### Portrait

```{r, fig.width = 2.9, fig.height = 3.5, results = "asis"}

plot_data <- site_odds %>% 
  add_column(contrast_variable = "Site") %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.05) %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  # filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label_super), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥+0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label_super, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label_super))) +
  geom_tile(aes(fill = cluster_label_super)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label_super))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label_super$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 22)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.725, 0.8)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.725, 0.8)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.7, 0.9)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_site_portrait.pdf",
           p, width = 2.9, height = 3.5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_site_portrait.png",
           p, width = 2.9, height = 3.5)

```

### GLM with fixed effects (signature + megasite + signature * megasite) {.tabset}

```{r}

data[["Myeloid cell"]] <- scrna_cluster_super_sample_tbl %>%
  filter(tumor_megasite != "Ascites")
formulas[["Myeloid cell"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label_super * consensus_signature + cluster_label_super * tumor_megasite + cluster_label_super * consensus_signature * tumor_megasite #+ cluster_label_super * sort_parameters
models[["Myeloid cell"]] <- glm(formula = formulas[["Myeloid cell"]], family = binomial(link = 'logit'), data = data[["Myeloid cell"]])

consensus_signature_site_emm[["Myeloid cell"]] <- emmeans(models[["Myeloid cell"]], specs = eff ~ consensus_signature * tumor_megasite | cluster_label_super, type = "response", tran = "logit", adjust = "bonferroni")
consensus_signature_site_odds <- consensus_signature_site_emm[["Myeloid cell"]]$contrasts %>%
    rbind() %>%
    as.data.frame()

```

##### Megasite x signature contrasts

###### Portrait

```{r, fig.width = 3.2, fig.height = 3.75, results = "asis"}

plot_data <- consensus_signature_site_odds %>% 
  add_column(contrast_variable = "Site/Signature") %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.05) %>%
  mutate(p.value = ifelse(p.value < 1E-20, 1E-20, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) %>%
  mutate(contrast = ordered(contrast, levels = as.vector(t(outer(names(clrs$consensus_signature), names(clrs$tumor_megasite), paste, sep=" "))))) %>%
  mutate(consensus_signature_contrast = ordered(consensus_signature_contrast, levels = names(clrs$consensus_signature))) %>%
  mutate(tumor_megasite_contrast = ordered(tumor_megasite_contrast, levels = names(clrs$tumor_megasite))) %>%
  mutate(cluster_label_super = ordered(cluster_label_super, levels = c("M1", "M2", "DC", "Other"))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label_super), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 20),
    breaks = c(0, 10, 20),
    labels = c(0, 10, 20)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free")#, switch = "x")

p_site_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = tumor_megasite_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$tumor_megasite) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray95')) +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_text(face = "plain"),
    legend.position = "bottom") +
  guides(fill = F)

p_signature_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = consensus_signature_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$wgs_signature, limits = force) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray90')) +
  labs(fill = "Mutational\nsignature") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank())
  # guides(fill = F)

p_signature_site_anno <- plot_grid(
  p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  nrow = 2,
  align = "v",
  axis = "lr")

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label_super, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label_super))) +
  geom_tile(aes(fill = cluster_label_super)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label_super))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label_super$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    # axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + 
      theme(plot.margin = margin(t = 5, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 3,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.3, 0.5, 0.25)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_signature_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_odds_ratio + 
      theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    ggdraw() + 
      draw_label("Site/Signature"),
    nrow = 4,
    align = "v",
    axis = "lr",
    rel_heights = c(0.2, 0.1, 0.5, 0.25)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.3, 0.66)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.15)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_megasite_signature_portrait.pdf",
           p, width = 3.2, height = 3.75)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_super_odds_ratio_megasite_signature_portrait.png",
           p, width = 3.2, height = 3.75)

```


## Myeloid cell clusters {.tabset}

```{r}

scrna_cluster_sample_tbl <- scrna_cell_tbl %>%
  # filter(tumor_supersite != "Ascites") %>%
  mutate(cell_type = case_when(
        str_detect(cluster_label, "M1") ~ "Macrophage",
        str_detect(cluster_label, "M2") ~ "Macrophage",
        str_detect(cluster_label, "Clearing.M") ~ "Macrophage",
        str_detect(cluster_label, "Cycling.M") ~ "Macrophage",
        str_detect(cluster_label, "DC") ~ "DC",
        str_detect(cluster_label, "Mast") ~ "DC",
        TRUE ~ "Other"
        )) %>%
  group_by(patient_id, consensus_signature, consensus_signature_short, BRCA_mutation_status, tumor_megasite, tumor_type, tumor_supersite, tumor_subsite, therapy, sort_parameters, cell_type, cluster_label) %>%
  summarize(cell_state_count = n_distinct(cell_id)) %>% 
  mutate(
      other_cell_state_count = sum(cell_state_count) - cell_state_count,
      total_cell_state_count = sum(cell_state_count),
      cell_state_proportion = cell_state_count/total_cell_state_count*100
      ) %>%
  ungroup

```

### GLM with fixed effects (signature + site) {.tabset}

#### Joint macrophage/DC compartments

```{r}

data[["Monocyte"]] <- scrna_cluster_sample_tbl
formulas[["Monocyte"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_supersite #+ cluster_label * sort_parameters
models[["Monocyte"]] <- glm(formula = formulas[["Monocyte"]], family = binomial(link = 'logit'), data = data[["Monocyte"]])

consensus_signature_emm[["Monocyte"]] <- emmeans(models[["Monocyte"]], specs = eff ~ consensus_signature | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
consensus_signature_odds <- consensus_signature_emm[["Monocyte"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

site_emm[["Monocyte"]] <- emmeans(models[["Monocyte"]], specs = eff ~ tumor_supersite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
site_odds <- site_emm[["Monocyte"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

```

##### Signature + site contrasts

###### Portrait

```{r, fig.width = 4.5, fig.height = 6, results = "asis"}

plot_data <- bind_rows(consensus_signature_odds %>% add_column(contrast_variable = "Signature"),
                       site_odds %>% add_column(contrast_variable = "Site")) %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  filter(!str_detect(contrast, "HRD effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  filter(p.value < 1E-20) %>%
  filter(SE < 0.15) %>%
  ggplot(aes(x = forcats::fct_rev(contrast), y = cluster_label, color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_cluster_anno + theme(plot.margin = margin(t = 24, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 0.575)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_signature_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 0.575)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.6, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.175)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_site_portrait.pdf", 
           p, width = 4.5, height = 6)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_site_portrait.png", 
           p, width = 4.5, height = 6)

```

###### Landscape

```{r, fig.width = 4.6, fig.height = 5, results = "asis"}

plot_data <- bind_rows(consensus_signature_odds %>% add_column(contrast_variable = "Signature"),
                       site_odds %>% add_column(contrast_variable = "Site")) %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  filter(!str_detect(contrast, "HRD effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  filter(p.value < 1E-20) %>%
  filter(SE < 0.15) %>%
  ggplot(aes(x = cluster_label, y = forcats::fct_rev(contrast), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_x_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(contrast_variable ~ ., scales = "free_y", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=0, y=forcats::fct_rev(contrast), fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(contrast_variable~., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(cluster_label, facet_helper, fill = cluster_label)) +
  geom_point(aes(cluster_label, facet_helper), color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(cluster_label, facet_helper, label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(~facet_helper, scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_signature_site_anno + theme(plot.margin = margin(t = 6, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 0.7),
    rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_cluster_anno + theme(plot.margin = margin(t = 0, r = 6, b = 6, l = 6)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 0.7),
    rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.66, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.175)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_site_landscape.pdf", 
           p, width = 4.5, height = 5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_site_landscape.png", 
           p, width = 4.5, height = 5)

```

##### Signature contrasts

###### Portrait

```{r, fig.width = 3, fig.height = 5.9, results = "asis"}

plot_data <- consensus_signature_odds %>% 
  add_column(contrast_variable = "Signature") %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.6, 0.6, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.6, -0.6, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.6, 0.6),
    labels = c("≤-0.6", 0, "≥0.6"),
    breaks = c(-0.6, 0, 0.6)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_signature_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$consensus_signature) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(# aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(# aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 5, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.385, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.385, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(1.4, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.15)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_portrait.pdf",
           p, width = 3, height = 5.9)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_portrait.png",
           p, width = 3, height = 5.9)

```

###### Landscape

```{r, fig.width = 4.45, fig.height = 3.5, results = "asis"}

plot_data <- consensus_signature_odds %>% 
  add_column(contrast_variable = "Signature") %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = cluster_label, y = forcats::fct_rev(contrast), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_x_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(contrast_variable ~ ., scales = "free_y", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=0, y=forcats::fct_rev(contrast), fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(contrast_variable~., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(cluster_label, facet_helper, fill = cluster_label)) +
  geom_point(aes(cluster_label, facet_helper), color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(cluster_label, facet_helper, label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(~facet_helper, scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_signature_site_anno + theme(plot.margin = margin(t = 6, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 1.3),
    rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_cluster_anno + theme(plot.margin = margin(t = 0, r = 6, b = 6, l = 6)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 1.3),
    rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.46, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.175)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_landscape.pdf", 
           p, width = 4.45, height = 3.5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_landscape.png", 
           p, width = 4.45, height = 3.5)

```

##### Site contrasts

###### Portrait

```{r, fig.width = 3.8, fig.height = 6, results = "asis"}

plot_data <- site_odds %>% 
  add_column(contrast_variable = "Site") %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.575, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.575, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(1.15, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.17)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_site_portrait.pdf", 
           p, width = 3.8, height = 6)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_site_portrait.png", 
           p, width = 3.8, height = 6)

```

###### Landscape

```{r, fig.width = 5.25, fig.height = 4, results = "asis"}

plot_data <- site_odds %>% 
  add_column(contrast_variable = "Site") %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = cluster_label, y = forcats::fct_rev(contrast), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_x_discrete(drop = FALSE) +
  theme(
    #aspect.ratio = 1,
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(contrast_variable ~ ., scales = "free_y", space = "free")

p_signature_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=0, y=forcats::fct_rev(contrast), fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = c(clrs$consensus_signature, clrs$tumor_supersite)) +
  facet_grid(contrast_variable~., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(cluster_label, facet_helper, fill = cluster_label)) +
  geom_point(aes(cluster_label, facet_helper), color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(cluster_label, facet_helper, label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(~facet_helper, scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    p_signature_site_anno + theme(plot.margin = margin(t = 6, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(1, 1.1),
    rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    p_cluster_anno + theme(plot.margin = margin(t = 0, r = 6, b = 6, l = 6)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(1, 1.1),
    rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.53, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_site_landscape.pdf", p,
           width = 5.25, height = 4)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_site_landscape.png", p,
           width = 5.25, height = 4)

```

#### Separate macrophage/DC compartments

```{r}

data[["Macrophage"]] <- scrna_cluster_sample_tbl %>%
  filter(cell_type == "Macrophage")
formulas[["Macrophage"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_supersite + cluster_label#+ cluster_label * sort_parameters
models[["Macrophage"]] <- glm(formula = formulas[["Macrophage"]], family = binomial(link = 'logit'), data = data[["Macrophage"]])

data[["DC"]] <- scrna_cluster_sample_tbl %>%
  filter(cell_type == "DC")
formulas[["DC"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_supersite#+ cluster_label * sort_parameters
models[["DC"]] <- glm(formula = formulas[["DC"]], family = binomial(link = 'logit'), data = data[["DC"]])

consensus_signature_emm[["Macrophage"]] <- emmeans(models[["Macrophage"]], specs = eff ~ consensus_signature | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
consensus_signature_emm[["DC"]] <- emmeans(models[["DC"]], specs = eff ~ consensus_signature | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")

consensus_signature_site_odds <- bind_rows(
  consensus_signature_site_emm[["Macrophage"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "Macrophage"),
  consensus_signature_site_emm[["DC"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "DC")
  )

site_emm[["Macrophage"]] <- emmeans(models[["Macrophage"]], specs = eff ~ tumor_supersite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
site_emm[["DC"]] <- emmeans(models[["DC"]], specs = eff ~ tumor_supersite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")

site_odds <- bind_rows(
  site_emm[["Macrophage"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "Macrophage",
           contrast_type = "All vs all"),
  pairs(site_emm[["Macrophage"]])$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "Macrophage",
           contrast_type = "Pairwise"),
  site_emm[["DC"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "DC",
           contrast_type = "All vs all"),
  pairs(site_emm[["DC"]])$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "DC",
           contrast_type = "Pairwise")
  )

```

##### Site contrasts

###### All vs all

```{r, fig.width = 3.15, fig.height = 3.8, results = "asis"}

plot_data <- site_odds %>% 
  filter(cell_type == "DC",
         contrast_type == "All vs all") %>%
  add_column(contrast_variable = "Site") %>%
  mutate(p.value = ifelse(p.value < 1E-20, 1E-20, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 20),
    breaks = c(0, 10, 20),
    labels = c(0, 10, 20)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.85, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.85, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.65, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.17)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_site_all_vs_all_contrasts_portrait.pdf",
           p, width = 3.2, height = 3.9)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_site_all_vs_all_contrasts_portrait.png",
           p, width = 3.2, height = 3.9)

```


```{r}

plot_data <- site_odds %>% 
  filter(cell_type == "DC",
         contrast_type == "All vs all") %>%
  add_column(contrast_variable = "Site") %>%
  # mutate(p.value = ifelse(p.value < 1E-20, 1E-20, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) 

scrna_glm_table <- plot_data %>%
  select(-c("df","null","contrast_variable"))

glm_list <-
  list(
    "scRNA DCs/Site" = scrna_glm_table
  )

library(openxlsx)

wb <- createWorkbook()
lapply(seq_along(glm_list), function(i){
  addWorksheet(wb=wb, sheetName = names(glm_list[i]))
  writeData(wb, sheet = i, glm_list[[i]])
})

saveWorkbook(wb, "tables/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_site_all_vs_all_contrasts.xlsx", overwrite = TRUE)

```


```{r, fig.width = 3.7, fig.height = 4.75, results = "asis"}

plot_data <- site_odds %>% 
  filter(cell_type == "Macrophage",
         contrast_type == "All vs all") %>%
  add_column(contrast_variable = "Site") %>%
  mutate(p.value = ifelse(p.value < 1E-40, 1E-40, p.value)) %>%
  mutate(contrast = str_remove_all(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 40),
    breaks = c(0, 20, 40),
    labels = c(0, 20, 40)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.6, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.6, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.9, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.19)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_site_all_vs_all_contrasts_portrait.pdf",
           p, width = 3.7, height = 4.75)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_site_all_vs_all_contrasts_portrait.png",
           p, width = 3.7, height = 4.75)

```


```{r}

plot_data <- site_odds %>% 
  filter(cell_type == "Macrophage",
         contrast_type == "All vs all") %>%
  add_column(contrast_variable = "Site") %>%
  # mutate(p.value = ifelse(p.value < 1E-40, 1E-40, p.value)) %>%
  mutate(contrast = str_remove_all(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) 

scrna_glm_table <- plot_data %>%
  select(-c("df","null","contrast_variable"))

glm_list <-
  list(
    "scRNA Mph/Site" = scrna_glm_table
  )

library(openxlsx)

wb <- createWorkbook()
lapply(seq_along(glm_list), function(i){
  addWorksheet(wb=wb, sheetName = names(glm_list[i]))
  writeData(wb, sheet = i, glm_list[[i]])
})

saveWorkbook(wb, "tables/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_site_all_vs_all_contrasts.xlsx", overwrite = TRUE)

```

```{r}

site_macrophage_dc_tbl <- site_odds %>% 
  filter(contrast_type == "All vs all") %>%
  mutate(contrast = str_remove_all(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  select(-c("contrast_type")) %>%
  group_split(cell_type, .keep = FALSE)

site_macrophage_dc_tbl

```

###### Pairwise

```{r, fig.width = 2.25, fig.height = 3.8, results = "asis"}

plot_data <- site_odds %>% 
  filter(cell_type == "DC",
         contrast_type == "Pairwise") %>%
  add_column(contrast_variable = "Site") %>%
  mutate(p.value = ifelse(p.value < 1E-10, 1E-10, p.value)) %>%
  mutate(contrast = str_remove_all(contrast, " effect")) %>%
  filter(contrast %in% c("Adnexa / Bowel", "Adnexa / Omentum", "Bowel / Omentum")) %>%
  # mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  # filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.3, 0.3, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.3, -0.3, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.3, 0.3),
    labels = c("≤-0.3", 0, "≥0.3"),
    breaks = c(-0.3, 0, 0.3)
  ) +
  scale_size_continuous(
    limits = c(0, 10),
    breaks = c(0, 5, 10),
    labels = c(0, 5, 10)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.85, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.85, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.65, 0.55)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.17)
  )

p

# ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_site_pairwise_contrasts_portrait.pdf",
#            p, width = 3.2, height = 3.9)
# ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_site_pairwise_contrasts_portrait.png",
#            p, width = 3.2, height = 3.9)

```


```{r, fig.width = 2.7, fig.height = 4.75, results = "asis"}

plot_data <- site_odds %>% 
  filter(cell_type == "Macrophage",
         contrast_type == "Pairwise") %>%
  add_column(contrast_variable = "Site") %>%
  # mutate(p.value = ifelse(p.value < 1E-40, 1E-40, p.value)) %>%
  mutate(contrast = str_remove_all(contrast, " effect")) %>%
  filter(contrast %in% c("Adnexa / Bowel", "Adnexa / Omentum", "Bowel / Omentum")) %>%
  # mutate(contrast = ordered(contrast, levels = c(names(clrs$consensus_signature), names(clrs$tumor_supersite)))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  # filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 0.5, 0.5, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -0.5, -0.5, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-0.5, 0.5),
    labels = c("≤-0.5", 0, "≥0.5"),
    breaks = c(-0.5, 0, 0.5)
  ) +
  scale_size_continuous(
    limits = c(0, 40),
    breaks = c(0, 20, 40),
    labels = c(0, 20, 40)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colourbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_site_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$tumor_supersite) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 6, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.6, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 6, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 6, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.6, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.9, 0.5)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.19)
  )

p

# ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_site_pairwise_contrasts_portrait.pdf",
#            p, width = 3.7, height = 4.75)
# ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_site_pairwise_contrasts_portrait.png",
#            p, width = 3.7, height = 4.75)

```

### GLM with fixed effects (signature + megasite + signature * megasite) {.tabset}

#### Joint macrophage/DC compartments

```{r}

data[["Macrophage"]] <- scrna_cluster_sample_tbl %>%
  filter(tumor_megasite != "Ascites")
formulas[["Macrophage"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_megasite + cluster_label * consensus_signature * tumor_megasite#+ cluster_label * sort_parameters
models[["Macrophage"]] <- glm(formula = formulas[["Macrophage"]], family = binomial(link = 'logit'), data = data[["Macrophage"]])

consensus_signature_site_emm[["Macrophage"]] <- emmeans(models[["Macrophage"]], specs = eff ~ consensus_signature * tumor_megasite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")

consensus_signature_site_odds <- consensus_signature_site_emm[["Macrophage"]]$contrasts %>%
    rbind() %>%
    as.data.frame()

```

##### Signature x megasite contrasts

###### Portrait

```{r, fig.width = 6.5, fig.height = 5, results = "asis"}

plot_data <- consensus_signature_site_odds %>%
  add_column(contrast_variable = "Signature/Site") %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  # filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) %>%
  mutate(contrast = ordered(contrast, levels = as.vector(t(outer(names(clrs$consensus_signature), names(clrs$tumor_megasite), paste, sep=" "))))) %>%
  mutate(consensus_signature_contrast = ordered(consensus_signature_contrast, levels = names(clrs$consensus_signature))) %>%
  mutate(tumor_megasite_contrast = ordered(tumor_megasite_contrast, levels = names(clrs$tumor_megasite))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free")#, switch = "x")

p_signature_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = consensus_signature_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$consensus_signature) +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray95')) +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_text(face = "plain"),
    legend.position = "bottom") +
  guides(fill = F)

p_site_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = tumor_megasite_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$tumor_megasite) +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray90')) +
  labs(fill = "Site") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank())
  # guides(fill = F)

p_signature_site_anno <- plot_grid(
  p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  nrow = 2,
  align = "v",
  axis = "lr")

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    # axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + 
      theme(plot.margin = margin(t = 5, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 3,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.3, 1, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_middle <-
  plot_grid(
    # p_signature_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_signature_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_site_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_odds_ratio + 
      theme(legend.position = "none", plot.margin = margin(t = 6, r = 0, b = 0, l = 0)),
    ggdraw() + 
      draw_label("Signature/Site"),
    nrow = 4,
    align = "v",
    axis = "lr",
    rel_heights = c(0.2, 0.1, 1, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_right <- 
  plot_grid(
    ggdraw(),
    get_legend(p_site_anno),
    ggdraw(),
    nrow = 3,
    align = "v",
    axis = "lr",
    rel_heights = c(0.3, 1, 0.15)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_middle,
    ggdraw(),
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.6, 1, 0.05, 0.6)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.125)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_megasite_portrait.pdf",
           p, width = 6.5, height = 5)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_megasite_portrait.png",
           p, width = 6.5, height = 5)

```

#### Separate macrophage/DC compartments

```{r}

data[["Macrophage"]] <- scrna_cluster_sample_tbl %>%
  filter(cell_type == "Macrophage") %>%
  filter(tumor_megasite != "Ascites")
formulas[["Macrophage"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_megasite + cluster_label * consensus_signature * tumor_megasite#+ cluster_label * sort_parameters
models[["Macrophage"]] <- glm(formula = formulas[["Macrophage"]], family = binomial(link = 'logit'), data = data[["Macrophage"]])

data[["DC"]] <- scrna_cluster_sample_tbl %>%
  filter(cell_type == "DC") %>%
  filter(tumor_megasite != "Ascites")
formulas[["DC"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * consensus_signature + cluster_label * tumor_megasite + cluster_label * consensus_signature * tumor_megasite#+ cluster_label * sort_parameters
models[["DC"]] <- glm(formula = formulas[["DC"]], family = binomial(link = 'logit'), data = data[["DC"]])

consensus_signature_site_emm[["Macrophage"]] <- emmeans(models[["Macrophage"]], specs = eff ~ consensus_signature * tumor_megasite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
consensus_signature_site_emm[["DC"]] <- emmeans(models[["DC"]], specs = eff ~ consensus_signature * tumor_megasite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")

consensus_signature_site_odds <- bind_rows(
  consensus_signature_site_emm[["Macrophage"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "Macrophage"),
  consensus_signature_site_emm[["DC"]]$contrasts %>%
    rbind() %>%
    as.data.frame() %>%
    mutate(cell_type = "DC")
  )

```

##### Signature x megasite contrasts

###### Portrait

```{r, fig.width = 4.75, fig.height = 3.2, results = "asis"}

plot_data <- consensus_signature_site_odds %>%
  filter(cell_type == "DC") %>%
  add_column(contrast_variable = "Signature/Site") %>%
  mutate(p.value = ifelse(p.value < 1E-10, 1E-10, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) %>%
  mutate(contrast = ordered(contrast, levels = as.vector(t(outer(names(clrs$consensus_signature), names(clrs$tumor_megasite), paste, sep=" "))))) %>%
  mutate(consensus_signature_contrast = ordered(consensus_signature_contrast, levels = names(clrs$consensus_signature))) %>%
  mutate(tumor_megasite_contrast = ordered(tumor_megasite_contrast, levels = names(clrs$tumor_megasite))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 10),
    breaks = c(0, 5, 10),
    labels = c(0, 5, 10)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free")#, switch = "x")

p_site_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = tumor_megasite_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$tumor_megasite) +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray95')) +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_text(face = "plain"),
    legend.position = "bottom")
  # guides(fill = F)

p_signature_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = consensus_signature_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$wgs_signature, limits = force) +
  facet_grid(. ~ consensus_signature_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray90')) +
  labs(fill = "Mutational\nsignature") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_signature_site_anno <- plot_grid(
  p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  nrow = 2,
  align = "v",
  axis = "lr")

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    # axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + 
      theme(plot.margin = margin(t = 5, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 3,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.3, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_middle <-
  plot_grid(
    # p_signature_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_signature_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_site_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_odds_ratio + 
      theme(legend.position = "none", plot.margin = margin(t = 6, r = 0, b = 0, l = 0)),
    ggdraw() + 
      draw_label("Site/Signature"),
    nrow = 4,
    align = "v",
    axis = "lr",
    rel_heights = c(0.2, 0.1, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_right <- 
  plot_grid(
    ggdraw(),
    get_legend(p_site_anno),
    ggdraw(),
    nrow = 3,
    align = "v",
    axis = "lr",
    rel_heights = c(0.3, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_middle,
    ggdraw(),
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.45, 0.7, 0.05, 0.5)
    # rel_widths = c(0.425, 1, 0.05, 0.6)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_signature_megasite_portrait.pdf",
           p, width = 4.75, height = 3.2)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_signature_megasite_portrait.png",
           p, width = 4.75, height = 3.2)

```

##### Megasite x signature contrasts

###### Portrait

```{r, fig.width = 4.75, fig.height = 3.2, results = "asis"}

plot_data <- consensus_signature_site_odds %>%
  filter(cell_type == "DC") %>%
  add_column(contrast_variable = "Signature/Site") %>%
  mutate(p.value = ifelse(p.value < 1E-10, 1E-10, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) %>%
  mutate(contrast = ordered(contrast, levels = as.vector(t(outer(names(clrs$consensus_signature), names(clrs$tumor_megasite), paste, sep=" "))))) %>%
  mutate(consensus_signature_contrast = ordered(consensus_signature_contrast, levels = names(clrs$consensus_signature))) %>%
  mutate(tumor_megasite_contrast = ordered(tumor_megasite_contrast, levels = names(clrs$tumor_megasite))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 10),
    breaks = c(0, 5, 10),
    labels = c(0, 5, 10)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free")#, switch = "x")

p_site_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = tumor_megasite_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$tumor_megasite) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray95')) +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_text(face = "plain"),
    legend.position = "bottom") +
  guides(fill = F)

p_signature_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = consensus_signature_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$wgs_signature, limits = force) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray90')) +
  labs(fill = "Mutational\nsignature") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank())
  # guides(fill = F)

p_signature_site_anno <- plot_grid(
  p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  nrow = 2,
  align = "v",
  axis = "lr")

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    # axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + 
      theme(plot.margin = margin(t = 5, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 3,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.3, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_middle <-
  plot_grid(
    # p_signature_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_site_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_signature_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_odds_ratio + 
      theme(legend.position = "none", plot.margin = margin(t = 6, r = 0, b = 0, l = 0)),
    ggdraw() + 
      draw_label("Site/Signature"),
    nrow = 4,
    align = "v",
    axis = "lr",
    rel_heights = c(0.2, 0.1, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_right <- 
  plot_grid(
    ggdraw(),
    get_legend(p_signature_anno),
    ggdraw(),
    nrow = 3,
    align = "v",
    axis = "lr",
    rel_heights = c(0.3, 0.475, 0.15)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_middle,
    ggdraw(),
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.45, 0.7, 0.05, 0.5)
    # rel_widths = c(0.425, 1, 0.05, 0.6)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_megasite_signature_portrait.pdf",
           p, width = 4.75, height = 3.2)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_megasite_signature_portrait.png",
           p, width = 4.75, height = 3.2)

```

```{r}

plot_data <- consensus_signature_site_odds %>%
  filter(cell_type == "DC") %>%
  add_column(contrast_variable = "Signature/Site") %>%
  mutate(p.value = ifelse(p.value < 1E-10, 1E-10, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE)

scrna_glm_table <- plot_data %>%
  select(-c("df","null","contrast_variable","contrast"))

glm_list <-
  list(
    "scRNA DC/Site/Signature" = scrna_glm_table
  )

library(openxlsx)

wb <- createWorkbook()
lapply(seq_along(glm_list), function(i){
  addWorksheet(wb=wb, sheetName = names(glm_list[i]))
  writeData(wb, sheet = i, glm_list[[i]])
})

saveWorkbook(wb, "tables/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_DC_odds_ratio_megasite_signature.xlsx", overwrite = TRUE)

```

```{r, fig.width = 5.25, fig.height = 4.2, results = "asis"}

plot_data <- consensus_signature_site_odds %>%
  filter(cell_type == "Macrophage") %>%
  add_column(contrast_variable = "Signature/Site") %>%
  mutate(p.value = ifelse(p.value < 1E-50, 1E-50, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) %>%
  mutate(contrast = ordered(contrast, levels = as.vector(t(outer(names(clrs$consensus_signature), names(clrs$tumor_megasite), paste, sep=" "))))) %>%
  mutate(consensus_signature_contrast = ordered(consensus_signature_contrast, levels = names(clrs$consensus_signature))) %>%
  mutate(tumor_megasite_contrast = ordered(tumor_megasite_contrast, levels = names(clrs$tumor_megasite))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  filter(!str_detect(contrast, "Undetermined")) %>%
  filter(!str_detect(contrast, "Other")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  # filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 50),
    breaks = c(0, 25, 50),
    labels = c(0, 25, 50)
  ) +
  # scale_y_discrete(drop = FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    legend.box.just = "left",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank(),
    strip.text.x = element_blank()
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 1),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0, order = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free")#, switch = "x")

p_site_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = tumor_megasite_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$tumor_megasite) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray95')) +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_text(face = "plain"),
    legend.position = "bottom") +
  guides(fill = F)

p_signature_anno <- plot_data %>%
  distinct(contrast, contrast_variable, .keep_all = T) %>%
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = consensus_signature_contrast)) +
  heatmap_layers +
  scale_fill_manual(values = clrs$wgs_signature, limits = force) +
  facet_grid(. ~ tumor_megasite_contrast, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  # theme(panel.background = element_rect(fill = 'gray90')) +
  labs(fill = "Mutational\nsignature") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank())
  # guides(fill = F)

p_signature_site_anno <- plot_grid(
  p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  p_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
  nrow = 2,
  align = "v",
  axis = "lr")

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(#aspect.ratio = 1,
    axis.text.x = element_blank(),
    # axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 5, r = 0, b = 0, l = 6)),
    ggdraw(),
    nrow = 3,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.3, 0.75, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_middle <-
  plot_grid(
    # p_signature_site_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_site_anno + 
      theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0), legend.position = "none"),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 0, b = 0, l = 0)),
    ggdraw() + 
      draw_label("Site/Signature"),
    nrow = 4,
    align = "v",
    axis = "lr",
    rel_heights = c(0.2, 0.1, 0.75, 0.15)
    # rel_widths = c(0.75, 1)
  )

p_right <- 
  plot_grid(
    ggdraw(),
    get_legend(p_signature_anno),
    ggdraw(),
    nrow = 3,
    align = "v",
    axis = "lr",
    rel_heights = c(0.3, 0.75, 0.15)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_middle,
    ggdraw(),
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.6, 0.7, 0.05, 0.5)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.25)
  )

p

ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_megasite_signature_portrait.pdf",
           p, width = 5.25, height = 4.2)
ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macropahge_odds_ratio_megasite_signature_portrait.png",
           p, width = 5.25, height = 4.2)

```


```{r}

plot_data <- consensus_signature_site_odds %>%
  filter(cell_type == "Macrophage") %>%
  add_column(contrast_variable = "Signature/Site") %>%
  # mutate(p.value = ifelse(p.value < 1E-50, 1E-50, p.value)) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  separate(contrast, c("consensus_signature_contrast", "tumor_megasite_contrast"), sep = " ", remove = FALSE) 

scrna_glm_table <- plot_data %>%
  select(-c("df","null","contrast_variable","contrast"))

glm_list <-
  list(
    "scRNA Mph/Site/Signature" = scrna_glm_table
  )

library(openxlsx)

wb <- createWorkbook()
lapply(seq_along(glm_list), function(i){
  addWorksheet(wb=wb, sheetName = names(glm_list[i]))
  writeData(wb, sheet = i, glm_list[[i]])
})

saveWorkbook(wb, "tables/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_Macrophage_odds_ratio_megasite_signature.xlsx", overwrite = TRUE)

```


### GLM with fixed effects (signature + germline/somatic + site) {.tabset}

```{r}

data[["Monocyte"]] <- scrna_cluster_sample_tbl %>%
  # mutate(BRCA_mutation_status = if_else(BRCA_mutation_status == "Germline", paste(consensus_signature_short, BRCA_mutation_status), consensus_signature_short)) %>%
  # mutate(BRCA_mutation_status = glue::glue_collapse(na.omit(c(consensus_signature_short, BRCA_mutation_status)), sep = ", ")) %>%
  unite(., col = "BRCA_mutation_status", consensus_signature, BRCA_mutation_status, na.rm=TRUE, sep = " ") %>%
  mutate(BRCA_mutation_status = recode(BRCA_mutation_status, `HRD-Dup Germline` = "gHRD-Dup", `HRD-Del Germline` = "gHRD-Del", `HRD-Dup` = "ngHRD-Dup", `HRD-Del` = "ngHRD-Del"))
  # mutate(BRCA_mutation_status = ifelse(consensus_signature_short == "HRD" && BRCA_mutation_status != "Germline", "Somatic", BRCA_mutation_status))
formulas[["Monocyte"]] <-cbind(cell_state_count, other_cell_state_count) ~ cluster_label * BRCA_mutation_status + cluster_label * tumor_supersite #+ cluster_label * sort_parameters
models[["Monocyte"]] <- glm(formula = formulas[["Monocyte"]], family = binomial(link = 'logit'), data = data[["Monocyte"]])

# consensus_signature_emm[["Ovarian cancer cell"]] <- emmeans(models[["Ovarian cancer cell"]], specs = eff ~ consensus_signature | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
# consensus_signature_odds <- consensus_signature_emm[["Ovarian cancer cell"]]$contrasts %>%
#   rbind() %>%
#   as.data.frame()

BRCA_gene_mutation_status_emm[["Monocyte"]] <- emmeans(models[["Monocyte"]], specs = eff ~ BRCA_mutation_status | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
BRCA_gene_mutation_status_odds <- BRCA_gene_mutation_status_emm[["Monocyte"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

site_emm[["Monocyte"]] <- emmeans(models[["Monocyte"]], specs = eff ~ tumor_supersite | cluster_label, type = "response", tran = "logit", adjust = "bonferroni")
site_odds <- site_emm[["Monocyte"]]$contrasts %>%
  rbind() %>%
  as.data.frame()

```

#### Germline/somatic contrasts

##### Portrait

```{r, fig.width = 4.1, fig.height = 5.7, results = "asis"}

plot_data <- bind_rows(BRCA_gene_mutation_status_odds %>% add_column(contrast_variable = "")) %>%
  mutate(p.value = ifelse(p.value < 1E-250, 1E-250, p.value)) %>%
  # filter(!str_detect(contrast, "(HRD-Other) effect")) %>%
  mutate(contrast = str_remove(contrast, " effect")) %>%
  mutate(contrast = str_remove(contrast, "\\(")) %>%
  mutate(contrast = str_remove(contrast, "\\)")) %>%
  mutate(contrast = ordered(contrast, levels = names(clrs$consensus_signature_BRCA_mutation_status))) %>%
  mutate(cluster_label = ordered(cluster_label, levels = names(clrs$cluster_label$Myeloid.super))) %>%
  # filter(!str_detect(contrast, "HRD-Other"),
  #        !str_detect(contrast, "Undetermined")) %>%
  mutate(log2.odds.ratio = log2(odds.ratio)) %>%
  mutate(log2.odds.ratio = ifelse(log2.odds.ratio > 1, 1, log2.odds.ratio),
         log2.odds.ratio = ifelse(log2.odds.ratio < -1, -1, log2.odds.ratio))

p_odds_ratio <- plot_data %>%
  # filter(p.value < 1E-20) %>%
  filter(SE < 0.15) %>%
  ggplot(aes(x = contrast, y = forcats::fct_rev(cluster_label), color = log2.odds.ratio, size = -log10(p.value))) +
  geom_point() +
  scale_color_gradientn(
    colors = rev(brewer.pal(9, "RdBu")),
    limits = c(-1, 1),
    labels = c("≤-1", 0, "≥1"),
    breaks = c(-1, 0, 1)
  ) +
  scale_size_continuous(
    limits = c(0, 250),
    breaks = c(0, 125, 250),
    labels = c(0, 125, 250)
  ) +
  scale_y_discrete(drop=FALSE) +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 14),
    legend.direction = "horizontal",
    legend.position = "top",
    legend.box = "horizontal",
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "plain", size = 14),
    strip.background = element_blank()#,
    # strip.text.x = element_blank()
  ) +
  guides(color = guide_colorbar(title.position="top", title.hjust = 0.5, title.vjust = 0),
         size = guide_legend(title.position="top", title.hjust = 0.5, title.vjust = 0)) +
  labs(title = NULL, x = NULL, y = NULL, color = 'log2(odds ratio)', size = "\n-log10(p value)") +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free", switch = "x")

p_signature_anno <- plot_data %>% 
  distinct(contrast, contrast_variable, .keep_all = T) %>% 
  ggplot() +
  geom_tile(aes(x=contrast, y=0, fill = contrast)) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$consensus_signature_BRCA_mutation_status) +
  facet_grid(. ~ contrast_variable, scales = "free", space = "free") +
  scale_x_discrete(position = "top") +
  theme(#aspect.ratio = 1,
        axis.text.x.top = element_text(hjust = 0, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_cluster_anno <- plot_data %>% 
  mutate(facet_helper = "") %>% 
  distinct(cluster_label, facet_helper, .keep_all = T) %>% 
  ggplot(aes(x=facet_helper, y=forcats::fct_rev(cluster_label))) +
  geom_tile(aes(fill = cluster_label)) +
  geom_point(color = "white", alpha = 0.5, size = 5) +
  geom_text(aes(label = as.numeric(cluster_label))) +
  heatmap_layers + 
  scale_fill_manual(values = clrs$cluster_label$Myeloid.super) +
  scale_x_discrete(drop = FALSE) +
  facet_grid(facet_helper ~ ., scales = "free", space = "free") +
  theme(# aspect.ratio = 1,
        axis.text.x = element_blank(),
        strip.text = element_blank()) +
  guides(fill = F)

p_left <-
  plot_grid(
    ggdraw(),
    p_cluster_anno + theme(plot.margin = margin(t = 5, r = 0, b = 22, l = 6)),
    nrow = 2,
    align = "hv",
    axis = "tbr",
    rel_heights = c(0.55, 1)
    # rel_widths = c(0.75, 1)
  )

p_right <-
  plot_grid(
    p_signature_anno + theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0)),
    p_odds_ratio + theme(legend.position = "none", plot.margin = margin(t = 6, r = 0, b = 0, l = 0)),
    nrow = 2,
    align = "v",
    axis = "lr",
    rel_heights = c(0.55, 1)
    # rel_widths = c(0.75, 1)
  )

p <- plot_grid(
  plot_grid(
    p_left,
    p_right,
    nrow = 1,
    align = "hv",
    axis = "tblr",
    rel_widths = c(0.8, 1)
    ),
  get_legend(p_odds_ratio),
  ncol = 1,
  rel_heights = c(1, 0.2)
  )

p

# ggsave_pdf("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_portrait.pdf",
#            p, width = 4.1, height = 5.7)
# ggsave_png("figures/630_Myeloid_cell_glm/630_Myeloid_cell_cluster_odds_ratio_signature_portrait.png",
#            p, width = 4.1, height = 5.7)

```
