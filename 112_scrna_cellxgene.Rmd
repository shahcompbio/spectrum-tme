---
title: "scRNA data conversion for cellxgene"
subtitle: "MSK SPECTRUM"
author:
  - "Ignacio Vazquez-Garcia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: tango
    df_print: paged
    code_folding: hide
    fig_align: center
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: yes
params:
   rmd: "112_scrna_cellxgene.Rmd"
---

```{r setup, include=FALSE}
# Global knit options
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Global chunk options
knitr::opts_chunk$set(echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
```

```{r}

library(tidyverse)
library(Seurat)
library(SeuratData)
library(SeuratDisk)
library(googlesheets4)
library(cowplot)

source("src/global_vars.R")

```

## Load data

```{r}

seu_obj <- readr::read_rds("/work/shah/isabl_data_lake/analyses/68/75/6875/RNASCP/outs/integrated_seurat_final.rds")

```

## Load metadata

```{r}

gids <- list(
  "organism_ontology"="910670315",
  "cell_ontology"="2137427075",
  "disease_ontology"="1550965376",
  "sex_ontology"="1100516779",
  "tissue_ontology"="1819990913",
  "assay_ontology"="150407398"
)

url_template <- "https://docs.google.com/spreadsheets/d/15RWlyM8EfB7CgFGc22nIw0yBErkdHz0EFf0DYBMae2M/export?format=tsv&id=15RWlyM8EfB7CgFGc22nIw0yBErkdHz0EFf0DYBMae2M&gid="

ontology_list <- gids %>% 
  imap(~ str_c(url,.x)) %>%
  map(~read_tsv(.))

```

## Map cellxgene metadata

```{r, echo=FALSE}

scrna_meta_cell_tbl <- seu_obj@meta.data %>%
  # Add columns with constant values for all samples based on ontology table
  add_column(
    # organism & organism_ontology_term_id (Example: Homo sapiens, NCBITaxon:9606)
    ontology_list$organism_ontology,
  ) %>%
  # Add columns with sample-dependent values by mapping to ontology table
  left_join(
    db$sequencing_scrna,
    by = c("sample"="isabl_id")
  ) %>%
  mutate(
    # tissue & tissue_ontology_term_id (Example: Lung, UBERON:002048, or for cell cultures CL with both values appended with " (cell culture)")
    tissue = "",
    tissue_ontology_term_id = "",
    # assay & assay_ontology_term_id (Example: 10xV2 assay, EFO:0009899)
    assay = "",
    assay_ontology_term_id = "",
    # disease & disease_ontology_term_id (MONDO or normal/PATO:0000461 if healthy)
    disease = "",
    disease_ontology_term_id = "",
    # cell_type & cell_type_ontology_term_id ( Epithelial Cell, CL:0000066)
    # ethnicity & ethnicity_ontology_term_id (Example: Asian, HANCESTRO:0008, ‘unknown’ if info unavailable)
    ethnicity = "",
    ethnicity_ontology_term_id = "",
    # development_stage & development_stage_ontology_term _id (20-year-old human stage,HsapDv:0000114, ‘unknown’ if info unavailable)
    development_stage = "",
    development_stage_ontology_term = "",
    # sex & sex_ontology_term_id field – male (PATO:0000384) or female (PATO:0000383) ('unknown' if info unavailable)
    sex = "",
    sex_ontology_term_id = ""
  )

scrna_meta_cell_tbl

# seu_obj@meta.data <- scrna_meta_cell_tbl

```

## Export data

```{r}

# SaveH5Seurat(seu_obj, filename = "seu_obj.h5Seurat")
# Convert("seu_obj.h5Seurat", dest = "h5ad")

```