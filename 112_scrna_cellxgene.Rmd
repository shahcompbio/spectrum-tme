---
title: "scRNA data conversion for cellxgene"
subtitle: "MSK SPECTRUM"
author:
  - "Ignacio Vazquez-Garcia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: tango
    df_print: paged
    code_folding: hide
    fig_align: center
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: yes
params:
   rmd: "112_scrna_cellxgene.Rmd"
---

```{r setup, include=FALSE}
# Global knit options
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Global chunk options
knitr::opts_chunk$set(echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
```

```{r}

library(tidyverse)
library(Seurat)
library(SeuratData)
library(SeuratDisk)
library(googlesheets4)
library(cowplot)

source("src/global_vars.R")

```

## Load data

```{r}

seu_obj <- readr::read_rds("/work/shah/isabl_data_lake/analyses/68/75/6875/RNASCP/outs/integrated_seurat_final.rds")

```

## Load metadata

```{r}

gids <- list(
  "organism_ontology"="910670315",
  "tissue_ontology"="1819990913",
  "assay_ontology"="150407398",
  "disease_ontology"="1550965376",
  "cell_type_ontology"="2137427075",
  "ethnicity_ontology"="1904472753",
  "development_stage_ontology"="722315336",
  "sex_ontology"="1100516779"
)

url_template <- "https://docs.google.com/spreadsheets/d/15RWlyM8EfB7CgFGc22nIw0yBErkdHz0EFf0DYBMae2M/export?format=tsv&id=15RWlyM8EfB7CgFGc22nIw0yBErkdHz0EFf0DYBMae2M&gid="

ontology_list <- gids %>% 
  imap(~ str_c(url,.x)) %>%
  map(~read_tsv(.))

```

## Map cellxgene metadata

```{r, echo=FALSE}

# Duplicate Seurat object to add annotations
seu_obj_annotated <- seu_obj
scrna_meta_cell_tbl <- seu_obj_annotated@meta.data

# Add columns with constant values for all samples based on ontology table

## Organism ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # organism & organism_ontology_term_id (Example: Homo sapiens, NCBITaxon:9606)
  add_column(
    ontology_list$organism_ontology %>%
      select(c("organism", "organism_ontology_term_id")),
  )

# Add columns with sample-dependent values by mapping to ontology table

## Cell type ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # cell_type & cell_type_ontology_term_id (Epithelial Cell, CL:0000066)
  left_join(
    ontology_list$cell_type_ontology %>%
      select(c("cell_type", "cell_type_ontology_term_id")),
    by = "cell_type"
  )

## Assay ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # Add sample assay
  left_join(
    db$sequencing_scrna %>%
      select(c("isabl_id","platform")),
    by = c("sample"="isabl_id")
  ) %>%
  # assay & assay_ontology_term_id (Example: 10xV2 assay, EFO:0009899)
  left_join(
    ontology_list$assay_ontology %>%
      select(c("platform", "assay", "assay_ontology_term_id")),
    by = "platform"
  )

## Disease ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # Add sample assay
  left_join(
    db$gyn_diagnosis %>%
      select(c("patient_id","gyn_diagnosis_histology")),
    by = "patient_id"
  ) %>%
  # disease & disease_ontology_term_id (MONDO or normal/PATO:0000461 if healthy)
  left_join(
    ontology_list$disease_ontology %>%
      select(c("gyn_diagnosis_histology", "disease", "disease_ontology_term_id")),
    by = "gyn_diagnosis_histology"
  )

## Ethnicity ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # Add patient ethnicity
  left_join(
    db$patients %>%
      select(c("patient_id","patient_race")), 
    by = "patient_id"
  ) %>%
  # ethnicity & ethnicity_ontology_term_id (Example: Asian, HANCESTRO:0008, ‘unknown’ if info unavailable)
  left_join(
    ontology_list$ethnicity_ontology %>%
      select(c("patient_race", "ethnicity", "ethnicity_ontology_term_id")),
    by = "patient_race"
  )

## Sex ontology
scrna_meta_cell_tbl <- scrna_meta_cell_tbl %>%
  # Add patient sex
  left_join(
    db$patients %>%
      select(c("patient_id","patient_gender")), 
    by = "patient_id"
  ) %>%
  # sex & sex_ontology_term_id field – male (PATO:0000384) or female (PATO:0000383) ('unknown' if info unavailable)
  left_join(
    ontology_list$sex_ontology %>%
      select(c("patient_gender", "sex", "sex_ontology_term_id")),
    by = "patient_gender"
  )

scrna_meta_cell_tbl

seu_obj_annotated@meta.data <- scrna_meta_cell_tbl

```

## Export data

```{r}

SaveH5Seurat(seu_obj_annotated, filename = "seu_obj_annotated.h5Seurat")
Convert("seu_obj_annotated.h5Seurat", dest = "h5ad")

```